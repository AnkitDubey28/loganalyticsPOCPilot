{% extends "base.html" %}

{% block title %}Upload Logs{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üì§ Upload Logs</h2>
    <p>Upload log files or import from local folder for analysis</p>
</div>

<div class="upload-section">
    <div class="upload-card">
        <h3>üõ°Ô∏è Sentinel Agent - File Validation</h3>
        <p>Drag & drop files or click to browse. Supports .json, .csv, .log, .txt, .zip</p>
        
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" name="files" multiple accept=".json,.csv,.log,.txt,.zip">
                <label for="fileInput" class="file-input-label">
                    <span class="upload-icon">üìÅ</span>
                    <span>Choose Files</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary">Upload & Process</button>
        </form>

        <div class="divider">OR</div>

        <button id="importLocalBtn" class="btn btn-secondary">
            üìÇ Import from Local Folder
        </button>
        <p class="help-text">Imports from: data/incoming/</p>
    </div>

    <!-- NEW PLUGIN CONFIGURATION SECTION -->
    <div class="upload-card plugin-section">
        <h3>üîå Plugin Configuration</h3>
        <p>Configure data sources: APIs, Webhooks, SharePoint, or Cloud APIs</p>
        
        <div class="plugin-tabs">
            <button class="plugin-tab active" data-tab="cloud-api">‚òÅÔ∏è Cloud API</button>
            <button class="plugin-tab" data-tab="webhook">üîó Webhook</button>
            <button class="plugin-tab" data-tab="api">üåê REST API</button>
            <button class="plugin-tab" data-tab="sharepoint">üìé SharePoint</button>
        </div>

        <!-- Cloud API Form -->
        <form id="cloudApiForm" class="plugin-form active">
            <div class="form-group">
                <label for="cloudProvider">Cloud Provider *</label>
                <select id="cloudProvider" name="cloudProvider" required>
                    <option value="">Select Cloud Provider</option>
                    <option value="aws">AWS</option>
                    <option value="azure">Azure</option>
                    <option value="gcp">GCP</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div id="cloudSpecificFields"></div>

            <div class="form-group">
                <label for="cloudPluginName">Plugin Name *</label>
                <input type="text" id="cloudPluginName" name="pluginName" placeholder="e.g., AWS Production Logs" required>
            </div>

            <button type="submit" class="btn btn-primary">üíæ Save Cloud API Plugin</button>
        </form>

        <!-- Webhook Form -->
        <form id="webhookForm" class="plugin-form">
            <div class="form-group">
                <label for="webhookName">Webhook Name *</label>
                <input type="text" id="webhookName" name="webhookName" placeholder="e.g., CloudWatch Webhook" required>
            </div>
            <div class="form-group">
                <label for="webhookUrl">Webhook URL *</label>
                <input type="url" id="webhookUrl" name="webhookUrl" placeholder="https://example.com/webhook" required>
            </div>
            <div class="form-group">
                <label for="webhookSecret">Secret/Token</label>
                <input type="password" id="webhookSecret" name="webhookSecret" placeholder="Optional authentication token">
            </div>
            <div class="form-group">
                <label for="webhookMethod">HTTP Method *</label>
                <select id="webhookMethod" name="webhookMethod" required>
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save Webhook Plugin</button>
        </form>

        <!-- REST API Form -->
        <form id="apiForm" class="plugin-form">
            <div class="form-group">
                <label for="apiName">Data Source Name *</label>
                <input type="text" id="apiName" name="apiName" placeholder="e.g., Production Logs Storage" required>
            </div>
            <div class="form-group">
                <label for="apiEndpoint">Data Source URL *</label>
                <input type="url" id="apiEndpoint" name="apiEndpoint" placeholder="https://your-storage-url.com/logs/file.log" required>
            </div>
            <div class="form-group">
                <label for="apiKey">Access Token/Key *</label>
                <input type="password" id="apiKey" name="apiKey" placeholder="SAS token or Access key (optional)">
            </div>
            <div class="form-group">
                <label for="apiMethod">HTTP Method *</label>
                <select id="apiMethod" name="apiMethod" required>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save API Plugin</button>
        </form>

        <!-- SharePoint Form -->
        <form id="sharepointForm" class="plugin-form">
            <div class="form-group">
                <label for="sharepointName">SharePoint Name *</label>
                <input type="text" id="sharepointName" name="sharepointName" placeholder="e.g., Log Documents" required>
            </div>
            <div class="form-group">
                <label for="sharepointUrl">SharePoint Site URL *</label>
                <input type="url" id="sharepointUrl" name="sharepointUrl" placeholder="https://company.sharepoint.com/sites/logs" required>
            </div>
            <div class="form-group">
                <label for="sharepointFolder">Folder Path *</label>
                <input type="text" id="sharepointFolder" name="sharepointFolder" placeholder="/Shared Documents/Logs" required>
            </div>
            <div class="form-group">
                <label for="sharepointClientId">Client ID *</label>
                <input type="text" id="sharepointClientId" name="sharepointClientId" placeholder="Azure AD Client ID" required>
            </div>
            <div class="form-group">
                <label for="sharepointSecret">Client Secret *</label>
                <input type="password" id="sharepointSecret" name="sharepointSecret" placeholder="Azure AD Client Secret" required>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Save SharePoint Plugin</button>
        </form>

        <div id="pluginMessage" class="plugin-message" style="display: none;"></div>
    </div>

    <!-- Configured Plugins List -->
    <div class="upload-card">
        <h3>üìã Configured Plugins</h3>
        <div id="pluginsList">
            <p class="loading">Loading plugins...</p>
        </div>
    </div>

    <div class="results-card" id="resultsCard" style="display: none;">
        <h3>Processing Results</h3>
        <div id="resultsContainer"></div>
    </div>
</div>

<div class="agent-status">
    <h3>ü§ñ Active Agents</h3>
    <div class="agent-grid" id="agentGrid">
        <div class="agent-item">
            <span class="agent-icon">üõ°Ô∏è</span>
            <div>
                <strong>Sentinel</strong>
                <p>Validating uploads...</p>
            </div>
        </div>
        <div class="agent-item">
            <span class="agent-icon">üìí</span>
            <div>
                <strong>Ledger</strong>
                <p>Recording metadata...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle Event Hub fields visibility
function toggleEventHubFields() {
    const service = document.getElementById('azureService')?.value;
    const eventHubFields = document.getElementById('eventHubFields');
    if (eventHubFields) {
        eventHubFields.style.display = (service === 'eventhub') ? 'block' : 'none';
    }
}

// Cloud-specific field templates
const cloudFields = {
    aws: `
        <div class="form-group">
            <label for="awsAccessKey">AWS Access Key ID *</label>
            <input type="text" id="awsAccessKey" name="awsAccessKey" placeholder="AKIAIOSFODNN7EXAMPLE" required>
        </div>
        <div class="form-group">
            <label for="awsSecretKey">AWS Secret Access Key *</label>
            <input type="password" id="awsSecretKey" name="awsSecretKey" placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY" required>
        </div>
        <div class="form-group">
            <label for="awsSessionToken">AWS Session Token (Optional)</label>
            <input type="password" id="awsSessionToken" name="awsSessionToken" placeholder="Temporary session token (for STS/assumed roles)">
            <small class="help-text">Required when using temporary credentials from STS</small>
        </div>
        <div class="form-group">
            <label for="awsRegion">AWS Region *</label>
            <select id="awsRegion" name="awsRegion" required>
                <option value="us-east-1">US East (N. Virginia)</option>
                <option value="us-west-2">US West (Oregon)</option>
                <option value="eu-west-1">EU (Ireland)</option>
                <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="awsService">AWS Service *</label>
            <select id="awsService" name="awsService" required>
                <option value="cloudwatch">CloudWatch Logs</option>
                <option value="s3">S3 Bucket</option>
                <option value="cloudtrail">CloudTrail</option>
            </select>
        </div>
        <div class="form-group">
            <label for="awsLogGroup">Log Group/Bucket Name *</label>
            <input type="text" id="awsLogGroup" name="awsLogGroup" placeholder="/aws/lambda/my-function" required>
        </div>
    `,
    azure: `
        <div class="form-group">
            <label for="azureSubscriptionId">Subscription ID *</label>
            <input type="text" id="azureSubscriptionId" name="azureSubscriptionId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" required>
        </div>
        <div class="form-group">
            <label for="azureTenantId">Tenant ID *</label>
            <input type="text" id="azureTenantId" name="azureTenantId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" required>
        </div>
        <div class="form-group">
            <label for="azureClientId">Client ID *</label>
            <input type="text" id="azureClientId" name="azureClientId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" required>
        </div>
        <div class="form-group">
            <label for="azureClientSecret">Client Secret *</label>
            <input type="password" id="azureClientSecret" name="azureClientSecret" placeholder="Your client secret" required>
        </div>
        <div class="form-group">
            <label for="azureService">Azure Service *</label>
            <select id="azureService" name="azureService" required onchange="toggleEventHubFields()">
                <option value="monitor">Azure Monitor</option>
                <option value="storage">Storage Account</option>
                <option value="eventhub">Event Hub</option>
            </select>
        </div>
        <div class="form-group">
            <label for="azureResourceGroup">Resource Group *</label>
            <input type="text" id="azureResourceGroup" name="azureResourceGroup" placeholder="my-resource-group" required>
        </div>
        <div id="eventHubFields" style="display: none;">
            <div class="form-group">
                <label for="azureEventHubConnectionString">Event Hub Connection String</label>
                <input type="password" id="azureEventHubConnectionString" name="azureEventHubConnectionString" placeholder="Endpoint=sb://...">
                <small class="help-text">Full connection string with SharedAccessKey</small>
            </div>
            <div class="form-group">
                <label for="azureEventHubName">Event Hub Name</label>
                <input type="text" id="azureEventHubName" name="azureEventHubName" placeholder="my-event-hub">
            </div>
            <div class="form-group">
                <label for="azureEventHubConsumerGroup">Consumer Group</label>
                <input type="text" id="azureEventHubConsumerGroup" name="azureEventHubConsumerGroup" placeholder="$Default" value="$Default">
            </div>
        </div>
    `,
    gcp: `
        <div class="form-group">
            <label for="gcpProjectId">GCP Project ID *</label>
            <input type="text" id="gcpProjectId" name="gcpProjectId" placeholder="my-project-123456" required>
        </div>
        <div class="form-group">
            <label for="gcpServiceAccount">Service Account Email *</label>
            <input type="email" id="gcpServiceAccount" name="gcpServiceAccount" placeholder="service@project.iam.gserviceaccount.com" required>
        </div>
        <div class="form-group">
            <label for="gcpPrivateKey">Private Key (JSON) *</label>
            <textarea id="gcpPrivateKey" name="gcpPrivateKey" rows="4" placeholder="Paste your service account JSON key" required></textarea>
        </div>
        <div class="form-group">
            <label for="gcpService">GCP Service *</label>
            <select id="gcpService" name="gcpService" required>
                <option value="logging">Cloud Logging</option>
                <option value="storage">Cloud Storage</option>
                <option value="pubsub">Pub/Sub</option>
            </select>
        </div>
        <div class="form-group">
            <label for="gcpLogName">Log Name/Bucket *</label>
            <input type="text" id="gcpLogName" name="gcpLogName" placeholder="projects/my-project/logs/my-log" required>
        </div>
    `,
    other: `
        <div class="form-group">
            <label for="otherApiEndpoint">API Endpoint *</label>
            <input type="url" id="otherApiEndpoint" name="otherApiEndpoint" placeholder="https://api.cloudprovider.com/logs" required>
        </div>
        <div class="form-group">
            <label for="otherAuthType">Authentication Type *</label>
            <select id="otherAuthType" name="otherAuthType" required>
                <option value="bearer">Bearer Token</option>
                <option value="basic">Basic Auth</option>
                <option value="apikey">API Key</option>
            </select>
        </div>
        <div class="form-group">
            <label for="otherCredentials">Credentials *</label>
            <input type="password" id="otherCredentials" name="otherCredentials" placeholder="Your token/key" required>
        </div>
    `
};

// Tab switching
document.querySelectorAll('.plugin-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.plugin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.plugin-form').forEach(f => f.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab.replace('-', '') + 'Form').classList.add('active');
    });
});

// Cloud provider change handler
document.getElementById('cloudProvider').addEventListener('change', (e) => {
    const provider = e.target.value;
    const fieldsContainer = document.getElementById('cloudSpecificFields');
    fieldsContainer.innerHTML = provider ? cloudFields[provider] : '';
});

// Form submission handlers
async function submitPlugin(formData, pluginType) {
    try {
        const response = await fetch('/api/plugins', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                plugin_type: pluginType,
                config: Object.fromEntries(formData.entries())
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showMessage('‚úÖ Plugin saved successfully!', 'success');
            loadPlugins();
            return true;
        } else {
            showMessage('‚ùå Error: ' + data.error, 'error');
            return false;
        }
    } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
        return false;
    }
}

document.getElementById('cloudApiForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (await submitPlugin(new FormData(e.target), 'cloud-api')) {
        e.target.reset();
        document.getElementById('cloudSpecificFields').innerHTML = '';
    }
});

document.getElementById('webhookForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (await submitPlugin(new FormData(e.target), 'webhook')) e.target.reset();
});

document.getElementById('apiForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (await submitPlugin(new FormData(e.target), 'api')) e.target.reset();
});

document.getElementById('sharepointForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (await submitPlugin(new FormData(e.target), 'sharepoint')) e.target.reset();
});

function showMessage(message, type) {
    const msgDiv = document.getElementById('pluginMessage');
    msgDiv.textContent = message;
    msgDiv.className = 'plugin-message ' + type;
    msgDiv.style.display = 'block';
    setTimeout(() => msgDiv.style.display = 'none', 5000);
}

async function loadPlugins() {
    try {
        const response = await fetch('/api/plugins');
        const data = await response.json();
        displayPlugins(data.plugins || []);
    } catch (error) {
        document.getElementById('pluginsList').innerHTML = '<p class="error">Failed to load plugins</p>';
    }
}

function displayPlugins(plugins) {
    const container = document.getElementById('pluginsList');
    if (plugins.length === 0) {
        container.innerHTML = '<p>No plugins configured yet.</p>';
        return;
    }
    
    let html = '<div class="plugins-grid">';
    plugins.forEach(plugin => {
        const typeIcon = {
            'cloud-api': '‚òÅÔ∏è',
            'webhook': 'üîó',
            'api': 'üåê',
            'sharepoint': 'üìé'
        }[plugin.plugin_type] || 'üîå';
        
        html += `
            <div class="plugin-card" id="plugin-card-${plugin.id}">
                <div class="plugin-header">
                    <span class="plugin-icon">${typeIcon}</span>
                    <strong>${plugin.name || plugin.plugin_type}</strong>
                </div>
                <div class="plugin-details">
                    <small>Type: ${plugin.plugin_type}</small><br>
                    <small>Created: ${new Date(plugin.created_at).toLocaleDateString()}</small>
                </div>
                <div class="plugin-progress" id="progress-${plugin.id}" style="display:none;">
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" id="progress-bar-${plugin.id}"></div>
                    </div>
                    <small id="progress-text-${plugin.id}">0% - Initializing...</small>
                </div>
                <div class="plugin-actions">
                    <button class="btn-small btn-primary" onclick="executePlugin(${plugin.id})">üì• Fetch Data</button>
                    <button class="btn-small btn-danger" onclick="deletePlugin(${plugin.id})">Delete</button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

async function deletePlugin(id) {
    if (!confirm('Are you sure you want to delete this plugin?')) return;
    try {
        const response = await fetch(`/api/plugins/${id}`, {method: 'DELETE'});
        const data = await response.json();
        if (data.success) {
            showMessage('‚úÖ Plugin deleted successfully!', 'success');
            loadPlugins();
        }
    } catch (error) {
        showMessage('‚ùå Error deleting plugin', 'error');
    }
}

// Load plugins on page load
loadPlugins();

// Original upload functionality
document.getElementById('fileInput').addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
        const label = e.target.nextElementSibling;
        label.querySelector('span:last-child').textContent = `${files.length} file(s) selected`;
    }
});

document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;

    if (files.length === 0) {
        alert('Please select at least one file to upload');
        return;
    }

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    const resultsCard = document.getElementById('resultsCard');
    const resultsContainer = document.getElementById('resultsContainer');

    resultsCard.style.display = 'block';
    resultsContainer.innerHTML = '<div class="loading">‚è≥ Processing ' + files.length + ' file(s)...</div>';

    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
        }

        const data = await response.json();
        displayResults(data.results);

        e.target.reset();
        const label = fileInput.nextElementSibling;
        label.querySelector('span:last-child').textContent = 'Choose Files';
    } catch (error) {
        resultsContainer.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
    }
});

document.getElementById('importLocalBtn').addEventListener('click', async () => {
    const resultsCard = document.getElementById('resultsCard');
    const resultsContainer = document.getElementById('resultsContainer');

    resultsCard.style.display = 'block';
    resultsContainer.innerHTML = '<div class="loading">Importing files...</div>';

    try {
        const response = await fetch('/upload/local', {
            method: 'POST'
        });

        const data = await response.json();
        displayResults(data.results);
    } catch (error) {
        resultsContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
});

function displayResults(results) {
    const container = document.getElementById('resultsContainer');

    if (results.length === 0) {
        container.innerHTML = '<p>No files processed</p>';
        return;
    }

    const successCount = results.filter(r => r.status === 'success').length;
    const errorCount = results.filter(r => r.status === 'error' || r.status === 'rejected').length;

    let html = `
        <div class="results-summary">
            <div class="summary-item success">
                <strong>${successCount}</strong> successful
            </div>
            <div class="summary-item error">
                <strong>${errorCount}</strong> failed
            </div>
        </div>
        <table class="results-table">
            <thead>
                <tr>
                    <th>File</th>
                    <th>Status</th>
                    <th>Events</th>
                    <th>Cloud</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
    `;

    results.forEach(result => {
        const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
        const statusIcon = result.status === 'success' ? '‚úÖ' : '‚ùå';
        const cloudType = result.cloud_type || '-';
        const events = result.events !== undefined ? result.events : '-';
        const details = result.reason || result.message || '-';

        html += `
            <tr>
                <td><strong>${result.filename}</strong></td>
                <td class="${statusClass}">${statusIcon} ${result.status}</td>
                <td>${events}</td>
                <td>${cloudType}</td>
                <td><small>${details}</small></td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

async function executePlugin(pluginId) {
    const progressDiv = document.getElementById(`progress-${pluginId}`);
    const progressBar = document.getElementById(`progress-bar-${pluginId}`);
    const progressText = document.getElementById(`progress-text-${pluginId}`);
    
    progressDiv.style.display = 'block';
    progressText.textContent = '0% - Starting...';
    progressBar.style.width = '0%';
    
    try {
        // Start plugin execution
        const response = await fetch(`/api/plugins/${pluginId}/execute`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (!data.success) {
            showMessage('‚ùå Error: ' + data.error, 'error');
            progressDiv.style.display = 'none';
            return;
        }
        
        const executionId = data.execution_id;
        
        // Poll for progress
        const pollInterval = setInterval(async () => {
            try {
                const progressResponse = await fetch(`/api/plugins/progress/${executionId}`);
                const progressData = await progressResponse.json();
                
                const percent = progressData.percent || 0;
                const message = progressData.message || 'Processing...';
                
                progressBar.style.width = percent + '%';
                progressText.textContent = `${percent}% - ${message}`;
                
                if (progressData.done) {
                    clearInterval(pollInterval);
                    
                    if (progressData.result && progressData.result.success) {
                        const events = progressData.events || 0;
                        const filename = progressData.filename || 'unknown';
                        showMessage(`‚úÖ Success! Fetched and processed ${events} events from ${filename}`, 'success');
                        
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                        }, 3000);
                    } else {
                        const error = progressData.result?.error || progressData.error || 'Unknown error';
                        showMessage(`‚ùå Failed: ${error}`, 'error');
                        progressDiv.style.display = 'none';
                    }
                }
            } catch (error) {
                clearInterval(pollInterval);
                showMessage('‚ùå Error checking progress', 'error');
                progressDiv.style.display = 'none';
            }
        }, 500);
        
    } catch (error) {
        showMessage('‚ùå Error: ' + error.message, 'error');
        progressDiv.style.display = 'none';
    }
}

</script>
{% endblock %}
