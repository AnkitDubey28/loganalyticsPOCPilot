{% extends "base.html" %}

{% block title %}Processing Status{% endblock %}

{% block content %}
<div class="content">
    <h2>‚öôÔ∏è Processing Status</h2>
    <p>Monitor file processing and index building</p>

    <div class="card">
        <div class="card-header">
            <h3>üìí Ledger - Files Tracked</h3>
            <div class="filters-container">
                <input type="text" id="fileNameFilter" class="filter-input" placeholder="üîç Filter by filename...">
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="processed">Processed</option>
                    <option value="processing">Processing</option>
                    <option value="error">Error</option>
                </select>
                <select id="cloudFilter" class="filter-select">
                    <option value="">All Clouds</option>
                    <option value="aws">AWS</option>
                    <option value="azure">Azure</option>
                    <option value="gcp">GCP</option>
                    <option value="other">Other</option>
                </select>
                <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
            </div>
        </div>
        <div class="card-body" id="files-list">
            <p>Loading files...</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>üîó Nexus - Search Index</h3>
        </div>
        <div class="card-body">
            <div id="index-status">
                <p>Loading index status...</p>
            </div>
            <button onclick="rebuildIndex()" class="btn">Rebuild Index</button>
        </div>
    </div>

    <div id="build-progress" style="display: none;">
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <p id="progress-text">Building index...</p>
    </div>
</div>

<script>
let allFiles = [];

async function loadFiles() {
    try {
        const response = await fetch('/api/files');
        const data = await response.json();
        allFiles = data.files || [];
        renderFilteredFiles();
    } catch (error) {
        document.getElementById('files-list').innerHTML = '<p class="error">Failed to load files</p>';
    }
}

function renderFilteredFiles() {
    const container = document.getElementById('files-list');
    const nameFilter = document.getElementById('fileNameFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const cloudFilter = document.getElementById('cloudFilter').value;
    
    let filtered = allFiles.filter(f => {
        const matchName = !nameFilter || f.filename.toLowerCase().includes(nameFilter);
        const matchStatus = !statusFilter || f.status === statusFilter;
        const matchCloud = !cloudFilter || (f.cloud_type || 'other') === cloudFilter;
        return matchName && matchStatus && matchCloud;
    });
    
    if (filtered.length === 0) {
        container.innerHTML = '<p>No files match the filters.</p>';
        return;
    }

    let html = `<div class="filter-info">Showing ${filtered.length} of ${allFiles.length} files</div><table class="data-table"><thead><tr><th>File</th><th>Upload Time</th><th>Size</th><th>Status</th><th>Events</th><th>Cloud</th></tr></thead><tbody>`;

    filtered.forEach(f => {
        const statusClass = f.status === 'processed' ? 'status-success' : f.status === 'processing' ? 'status-warning' : 'status-error';
        html += `<tr>
            <td><a href="/view-file/${encodeURIComponent(f.filename)}" class="file-link" target="_blank">${f.filename}</a></td>
            <td>${new Date(f.upload_time).toLocaleString()}</td>
            <td>${(f.size / 1024).toFixed(2)} KB</td>
            <td><span class="${statusClass}">${f.status}</span></td>
            <td>${f.event_count || 0}</td>
            <td>${f.cloud_type || 'unknown'}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function clearFilters() {
    document.getElementById('fileNameFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('cloudFilter').value = '';
    renderFilteredFiles();
}

document.getElementById('fileNameFilter').addEventListener('input', renderFilteredFiles);
document.getElementById('statusFilter').addEventListener('change', renderFilteredFiles);
document.getElementById('cloudFilter').addEventListener('change', renderFilteredFiles);

async function loadIndexStatus() {
    try {
        const response = await fetch('/api/index/status');
        const data = await response.json();
        document.getElementById('index-status').innerHTML = `
            <p>Status: ${data.exists ? '‚úì Index built' : '‚ö† No index'}</p>
            ${data.last_build ? `<p>Last built: ${new Date(data.last_build).toLocaleString()}</p>` : ''}
        `;
    } catch (error) {
        document.getElementById('index-status').innerHTML = '<p class="error">Failed to load index status</p>';
    }
}

async function rebuildIndex() {
    document.getElementById('build-progress').style.display = 'block';
    try {
        const response = await fetch('/index/build', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            alert('Index rebuilt successfully!');
            loadIndexStatus();
        } else {
            alert('Failed to rebuild index: ' + data.reason);
        }
    } catch (error) {
        alert('Error rebuilding index');
    }
    document.getElementById('build-progress').style.display = 'none';
}

loadFiles();
loadIndexStatus();
setInterval(loadFiles, 5000);
</script>
{% endblock %}
